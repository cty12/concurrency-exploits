#!/bin/bash

# The following script will build apache-2.4.18

# Unzip the source file to current folder
if [ -f ../apps/httpd-2.4.18.tar.gz ]
then
    if [ ! -d httpd-2.4.18 ]
    then
        tar xzf ../apps/httpd-2.4.18.tar.gz
    else
        echo "Use existing httpd-2.4.18 source code."
    fi
else
    echo "Missing httpd-2.4.18 source file. Check Apps folder."
fi

tar -xf ../apps/apr-1.5.2.tar.gz -C httpd-2.4.18/srclib
tar -xf ../apps/apr-util-1.5.4.tar.gz -C httpd-2.4.18/srclib

mv httpd-2.4.18/srclib/apr-1.5.2 httpd-2.4.18/srclib/apr
mv httpd-2.4.18/srclib/apr-util-1.5.4 httpd-2.4.18/srclib/apr-util

# configure apache 2.4.18
cd httpd-2.4.18
cp ../before_configure.patch .
patch -p0 < before_configure.patch 

if [ $? -ne 0 ]
then
    echo "Couldn't apply before_configure.patch" 
    exit 1
fi

CFLAGS="-g -O0 -fsanitize=thread" CC="clang" CXX="clang++" ./configure --prefix=`pwd`/../apache-install-tsan --enable-modules="reallyall" --with-mpm=worker --enable-session --enable-session-cookie --enable-lua  --enable-proxy --enable-cache

make
make install
