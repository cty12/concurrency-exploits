#!/bin/bash

# Unzip the source file to current folder
if [[ ! -d mysql-5.1.35 ]]; then
    if [[ ! -f ../apps/mysql-5.1.35.tar.gz ]]; then
        wget http://downloads.mysql.com/archives/get/file/mysql-5.1.35.tar.gz -P ../apps/
	else
        echo "Using existing mysql-5.1.35.tar.gz source file"
	fi
fi

cd mysql-5.1.35

CFLAGS="-O0 -g -fsanitize=thread" CXXFLAGS="-O0 -g -fsanitize=thread" CC="clang" CXX="clang++" ./configure --prefix=`pwd`/../mysql-install-tsan --with-debug

patch < ../after_configuration.patch

if [ $? -ne 0 ]
then
    echo "Couldn't apply after_configure.patch" 
    exit 1
fi

make -16
make install



# This script builds the bug triggering input for MySQL 35589 bug. 
set -e

# Configure MySQL-5.0.35
mysql-install-tsan/mysql/bin/mysql_install_db --user=$USER

# build testcase
# Tsan build
clang bug35589.c -fsanitize=thread -g -o attack -L mysql-install-tsan/lib/mysql -I mysql-install-tsan/include/mysql -lmysqlclient_r -lz -lpthread
# Normal build
#clang bug35589.c -g -o attack -L mysql-install-tsan/lib/mysql -I mysql-install-tsan/include/mysql -lmysqlclient_r -lz -lpthread

# Start the MySQL server
./mysql-install-tsan/libexec/mysqld --user=$USER &
sleep 5
# ATTACK!
LD_LIBRARY_PATH=mysql-install-tsan/lib/mysql ./attack
