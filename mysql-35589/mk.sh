#!/bin/bash

# The following script will build mysql-5.1.35

if [ ! -d mysql-5.1.35 ]
then
    wget http://downloads.mysql.com/archives/get/file/mysql-5.1.35.tar.gz
    tar xzf mysql-5.1.35.tar.gz
else
    echo "Use existing mysql-5.1.35 source code."
fi


# configure mysql-5.1.35
cd mysql-5.1.35

CFLAGS="-O0 -g -fsanitize=thread" CXXFLAGS="-O0 -g -fsanitize=thread" CC="clang" CXX="clang++" ./configure --prefix=`pwd`/../mysql-install-tsan --with-debug

patch  < ../after_configuration.patch

if [ $? -ne 0 ]
then
    echo "Couldn't apply after_configure.patch" 
    exit 1
fi

make -j16
make install
