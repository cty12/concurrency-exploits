#!/bin/bash

# The following script will build mysql-5.1.35
if [ ! -d mysql-5.1.35 ]
then
    tar xzf ../apps/mysql-5.1.35.tar.gz
else
    echo "Use existing mysql-5.1.35 source code."
fi


# configure mysql-5.1.35
cd mysql-5.1.35
# Tsan build
CFLAGS="-O0 -g -fsanitize=thread" CXXFLAGS="-O0 -g -fsanitize=thread" CC="clang" CXX="clang++" ./configure --prefix=`pwd`/../mysql-install-tsan --with-debug
# Normal build
#CFLAGS="-O0 -g" CXXFLAGS="-O0 -g" CC="clang" CXX="clang++" ./configure --prefix=`pwd`/../mysql-install --with-debug
# !!Don't forget to change the path for patch

patch  < ../after_configuration.patch

if [ $? -ne 0 ]
then
    echo "Couldn't apply after_configure.patch" 
    exit 1
fi

make -16
make install

exit 0

# !!!!!!!!!!!!!!!!!!!!!!!!!!
# This part won't automatically run
# !!!!!!!!!!!!!!!!!!!!!!!!!!

# Start to listen to requests
mysql-install-tsan/libexec/mysqld --skip-grant &

# build testcase
# Tsan build
clang bug35589.c -fsanitize=thread -g -o attack -L mysql-install-tsan/lib/mysql -I mysql-install-tsan/include/mysql -lmysqlclient_r -lz -lpthread
# Normal build
#clang bug35589.c -g -o attack -L mysql-install-tsan/lib/mysql -I mysql-install-tsan/include/mysql -lmysqlclient_r -lz -lpthread

# Start the ATTACK!
LD_LIBRARY_PATH=mysql-install-tsan/lib/mysql ./attack
