#!/bin/bash

# Unzip the source file to current folder
if [[ ! -d mysql-5.1.35 ]]; then
    if [[ ! -f ../apps/mysql-5.1.35.tar.gz ]]; then
        wget http://downloads.mysql.com/archives/get/file/mysql-5.1.35.tar.gz -P ../apps/
	else
        echo "Using existing mysql-5.1.35.tar.gz source file"
	fi

	tar xzf ../apps/mysql-5.1.35.tar.gz
fi

cd mysql-5.1.35

CFLAGS="-O0 -g -fsanitize=thread" CXXFLAGS="-O0 -g -fsanitize=thread" CC="clang" CXX="clang++" ./configure --prefix=`pwd`/../mysql-install-tsan --with-debug

patch < ../after_configuration.patch

if [ $? -ne 0 ]
then
    echo "Couldn't apply after_configure.patch" 
    exit 1
fi

make -16
make install


