#!/bin/bash
set -e

# Configure MySQL-5.0.35
mysql-install-tsan/mysql/bin/mysql_install_db --user=$USER

# build testcase
clang bug35589.c -fsanitize=thread -g -o attack -L mysql-install-tsan/lib/mysql -I mysql-install-tsan/include/mysql -lmysqlclient_r -lz -lpthread

# Start the MySQL server
./mysql-install-tsan/libexec/mysqld --user=$USER &
sleep 5
# ATTACK!
LD_LIBRARY_PATH=mysql-install-tsan/lib/mysql ./attack
