#!/bin/bash

# The following script will download and build mysql-5.0.27

# Unzip the source file to current folder
if [ -f mysql-5.0.27.tar.gz ]
then
    if [ ! -d mysql-5.0.27 ]
    then
        tar xzf ../apps/mysql-5.0.27.tar.gz
    else
        echo "Use existing mysql-5.0.27 source code."
    fi
else
    echo "Missing mysql-5.0.27 source file, please check the wget link."
fi

pushd mysql-5.0.27

# Normal build
#CFLAGS="-O0 -g" CXXFLAGS="-O0 -g" CC="clang" CXX="clang++" ./configure --prefix=`pwd`/../mysql-install-clang --with-debug
# tsan build
CFLAGS="-O0 -g -fsanitize=thread" CXXFLAGS="-O0 -g -fsanitize=thread" CC="clang" CXX="clang++" ./configure --prefix=`pwd`/../mysql-install-tsan --with-debug
patch  < ../after_configuration.patch

make -j16
make install

popd

echo "Done building mysql!"
