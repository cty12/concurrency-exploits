#!/bin/bash

# The following script will download and build mysql-5.7.15

# Unzip the source file to current folder
if [ -f ../apps/mysql-server-5.7.zip ]
then
    if [ ! -d mysql-server-5.7 ]
    then
        unzip ../apps/mysql-server-5.7.zip > /dev/null
    else
        echo "Use existing mysql-5.7.15 source code."
    fi
else
    echo "Missing mysql-5.7.15 source file, please check the wget link."
fi

pushd mysql-server-5.7

mkdir build && cd build
sed -i '40, 41 s/^/#/' ../plugin/keyring/CMakeLists.txt
# Normal build
#CC=clang CXX=clang++  cmake .. -DDOWNLOAD_BOOST=1 -DWITH_BOOST=`pwd`/../../boost -DCMAKE_BUILD_TYPE=DEBUG -DCMAKE_C_FLAGS="-O0 -g" -DCMAKE_CXX_FLAGS="-O0 -g" -DCMAKE_INSTALL_PREFIX=`pwd`/../../mysql-install -DDISABLE_SHARED=ON
# tsan build
CC=clang CXX=clang++  cmake .. -DDOWNLOAD_BOOST=1 -DWITH_BOOST=`pwd`/../../boost -DCMAKE_BUILD_TYPE=DEBUG -DCMAKE_C_FLAGS="-O0 -g -fsanitize=thread" -DCMAKE_CXX_FLAGS="-O0 -g -fsanitize=thread" -DCMAKE_INSTALL_PREFIX=`pwd`/../../mysql-install -DDISABLE_SHARED=ON

make -j16
make install

popd

echo "Done building mysql-5.7.15!"
